<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>box test</title>
    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="http://code.jquery.com/jquery-migrate-1.1.0.min.js"></script>
  </head>
  <body>
      <a href="https://account.box.com/api/oauth2/authorize?response_type=code&client_id=xgz1419a7mgtkklko63fki4tim8kdfug&redirect_url=https://localhost:8888/box.html">Go</a>
  <a href="javascript:set();">Code</a>

  <text id="content">
  <form id="FILE_FORM" method="post" enctype="multipart/form-data" action="">

           <input type="file" name="profile" id="profile">
           <input type="submit">
           <a class="ui-shadow ui-btn ui-corner-all" href="javascript:uploadFile();">전송</a>
       </form>



      <script type="text/javascript">
      var Client_ID = "xgz1419a7mgtkklko63fki4tim8kdfug";
      var Client_SECRET="jX5a2NSLyRqVJcb1Cbicc5fW87mxDTLV";
      var access_token;
      var refresh_token;

      function getParams() {
      // 파라미터가 담길 배열
      var param = new Array();

      // 현재 페이지의 url
      var url = decodeURIComponent(location.href);
      // url이 encodeURIComponent 로 인코딩 되었을때는 다시 디코딩 해준다.
      url = decodeURIComponent(url);

      var params;
      // url에서 '?' 문자 이후의 파라미터 문자열까지 자르기
      params = url.substring( url.indexOf('?')+1, url.length );
      // 파라미터 구분자("&") 로 분리
      params = params.split("&");

      // params 배열을 다시 "=" 구분자로 분리하여 param 배열에 key = value 로 담는다.
      var size = params.length;
      var key, value;
      for(var i=0 ; i < size ; i++) {
          key = params[i].split("=")[0];
          value = params[i].split("=")[1];

          param[key] = value;
      }

      return param;
      }
      function set(){
      var p = getParams();
      var Code = p["code"];
      alert(Code);
      history.replaceState({}, null, location.pathname);
      var tokenurl ="https://api.box.com/oauth2/token";

       makeCorsRequest(Code);
      //simpleRequest(Code);
      }


        function createCORSRequest(method, url) {
  var xhr = new XMLHttpRequest();
  if ("withCredentials" in xhr) {
    // XHR for Chrome/Firefox/Opera/Safari.
    xhr.open(method, url);
  } else {
    // CORS not supported.
    xhr = null;
  }
  return xhr;
}

// Helper method to parse the title tag from the response.
function appendPre(message) {
  var pre = document.getElementById('content');
  var textContent = document.createTextNode(message + '\n');

  pre.appendChild(textContent);
}

// Make the actual CORS request.
function makeCorsRequest(Code) {
  // This is a sample server that supports CORS.
  var url = "https://api.box.com/oauth2/token";

  var xhr = createCORSRequest('POST', url);
  if (!xhr) {
    alert('CORS not supported');
    return;
  }


  // Response handlers.
  // xhr.onload = function(res) {
  //   var text = xhr.responseText;
  //
  //   var json = JSON.parse(xhr.responseText);
  //   for(access_token in json){
  //     alert("access_token : "+json[access_token]);
  //   }
  //   access_token = json.access_token;
  //   refresh_token = json.refresh_token;
  //   appendPre(text);
  // };

  xhr.onreadystatechange = function() {
    if (xhr.readyState == XMLHttpRequest.DONE) {
        alert(this.responseText);
    }
}
  xhr.onerror = function() {
    alert(xhr.statusText);
  };
  xhr.setRequestHeader('Access-Control-Allow-Origin','*');
  //https 서버이면 encoding 시켜야한다
  var data = "grant_type=authorization_code&client_id=xgz1419a7mgtkklko63fki4tim8kdfug&client_secret=jX5a2NSLyRqVJcb1Cbicc5fW87mxDTLV&code="+Code;

  xhr.send(data);
}




      //   new Ajax.Request("ReceiveJSON.jsp",
      //    {
      //     method: "post",
      //     parameters: { "grant_type" : 'authorization_code',
      //      "code" : Code,
      //      "client_id" : Client_ID,
      //      "client_secret" : Client_SECRET},
      //     onComplete: Respond
      //    });
      //
      // }
      // function Respond(req){
      //   alert(responseText);
      // }

      </script>

  </body>
</html>
